<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OBS Source Controller</title>

<style>
:root {
    --bg: #2f2f2f;
    --panel: #3c3c3c;
    --text: #ffffff;
    --border: #555;
    --radius: 10px;
}

* {
    box-sizing: border-box;
    font-family: Segoe UI, Roboto, Arial, sans-serif;
}

body {
    margin: 0;
    padding: 10px;
    background: var(--bg);
    color: var(--text);
}

.panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px;
    margin-bottom: 8px;
}

.controls {
    display: none;
}

label {
    font-size: 12px;
    opacity: 0.8;
}

button {
    width: 100%;
    padding: 8px;
    background: #3a3a3a;
    border: 1px solid var(--border);
    color: white;
    cursor: pointer;
    margin-bottom: 4px;
}

button:hover { background: #4a4a4a; }

.status {
    font-size: 12px;
    margin-top: 6px;
}

.connected { color: #4caf50; }
.disconnected { color: #ff5555; }
</style>
</head>
<body>

<div id="controls" class="controls">

    <div class="panel">
        <label>Source Movement</label>
        <button onclick="move('up')">⬆ Up</button>
        <button onclick="move('down')">⬇ Down</button>
        <button onclick="move('left')">⬅ Left</button>
        <button onclick="move('right')">➡ Right</button>

        <label>Zoom</label>
        <button onclick="zoom('in')">➕ Zoom In</button>
        <button onclick="zoom('out')">➖ Zoom Out</button>
    </div>

    <div class="panel">
        <label>Source Name</label>
        <input id="source" placeholder="Enter source name">
        <label>Move Step (px)</label>
        <input id="moveStep" type="number" value="10">
        <label>Zoom Step</label>
        <input id="zoomStep" type="number" step="0.01" value="0.1">
    </div>

</div>

<button class="toggle" onclick="toggleConnection()">⚙ Connection</button>

<div id="connectionPanel" class="panel">
    <label>Server IP</label>
    <input id="ip" placeholder="localhost">

    <label>Server Port</label>
    <input id="port" placeholder="4455">

    <label>Password</label>
    <input id="password" type="password">

    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>

    <div id="status" class="status disconnected">Disconnected</div>
</div>

<script>
let socket;
let identified = false;

function toggleConnection() {
    connectionPanel.style.display =
        connectionPanel.style.display === "none" ? "block" : "none";
}

async function connect() {
    socket = new WebSocket(`ws://${ip.value}:${port.value}`);

    socket.onmessage = async e => {
        const m = JSON.parse(e.data);

        // Authentication handshake
        if (m.op === 0) {
            let auth = {};
            if (m.d.authentication) {
                const s = await crypto.subtle.digest(
                    "SHA-256",
                    new TextEncoder().encode(password.value + m.d.authentication.salt)
                );
                const sb = btoa(String.fromCharCode(...new Uint8Array(s)));
                const r = await crypto.subtle.digest(
                    "SHA-256",
                    new TextEncoder().encode(sb + m.d.authentication.challenge)
                );
                auth.authentication = btoa(
                    String.fromCharCode(...new Uint8Array(r))
                );
            }
            socket.send(JSON.stringify({ op: 1, d: { rpcVersion: 1, ...auth } }));
        }

        // Connection identified
        if (m.op === 2) {
            identified = true;
            status.textContent = "Connected";
            status.className = "status connected";
            connectionPanel.style.display = "none";
            controls.style.display = "block";
        }
    };

    socket.onclose = () => {
        identified = false;
        status.textContent = "Disconnected";
        status.className = "status disconnected";
        controls.style.display = "none";
    };
}

function disconnect() { socket?.close(); }

// Send move command
function move(direction) {
    if (!identified) return;
    const source = document.getElementById("source").value;
    const step = parseFloat(document.getElementById("moveStep").value);

    const request = {
        "op": 6,
        "d": {
            "requestType": "SetSceneItemTransform",
            "requestId": crypto.randomUUID(),
            "requestData": {
                "scene-name": obsGetCurrentScene(),
                "item": source,
                "move": direction,
                "step": step
            }
        }
    };

    socket.send(JSON.stringify(request));
}

// Send zoom command
function zoom(action) {
    if (!identified) return;
    const source = document.getElementById("source").value;
    const step = parseFloat(document.getElementById("zoomStep").value);

    const request = {
        "op": 6,
        "d": {
            "requestType": "SetSceneItemTransform",
            "requestId": crypto.randomUUID(),
            "requestData": {
                "scene-name": obsGetCurrentScene(),
                "item": source,
                "zoom": action,
                "step": step
            }
        }
    };

    socket.send(JSON.stringify(request));
}

// Helper: get current scene name
function obsGetCurrentScene() {
    // For simplicity, you could hardcode your scene name here,
    // or implement OBS WebSocket call to get it dynamically
    return "Scene";
}
</script>

</body>
</html>
