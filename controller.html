<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OBS Camera Controller</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family: Arial, sans-serif;
  text-align:center;
}
button {
  font-size:16px;
  padding:10px 20px;
  margin:5px;
}
</style>
</head>

<body>

<h2>OBS Camera Controller</h2>

<div>
  <button onclick="zoom(1.1)">Zoom In</button>
  <button onclick="zoom(0.9)">Zoom Out</button>
</div>

<div>
  <button onclick="move(0,-20)">⬆</button><br>
  <button onclick="move(-20,0)">⬅</button>
  <button onclick="move(20,0)">➡</button><br>
  <button onclick="move(0,20)">⬇</button>
</div>

<div>
  <button onclick="resetView()">Reset</button>
</div>

<script>
// ======================
// USER SETTINGS (CHANGE THESE)
// ======================
const OBS_PASSWORD = "1mvxtIa6b7zyIVYQ";
const SCENE_NAME   = "Camera Scene";
const SOURCE_NAME  = "Atem Mini Pro";

// ======================
// INTERNAL STATE
// ======================
let ws;
let sceneItemId = null;
let scale = 1.0;
let posX = 0;
let posY = 0;

// ======================
// CONNECT TO OBS
// ======================
ws = new WebSocket("ws://localhost:4455");

ws.onmessage = async (event) => {
  const msg = JSON.parse(event.data);

  // 1️⃣ OBS says hello → authenticate
  if (msg.op === 0) {
    const { challenge, salt } = msg.d.authentication;

    const secret = await sha256(OBS_PASSWORD + salt);
    const auth   = await sha256(secret + challenge);

    ws.send(JSON.stringify({
      op: 1,
      d: {
        rpcVersion: 1,
        authentication: auth
      }
    }));
  }

  // 2️⃣ Authentication successful
  if (msg.op === 2) {
    request("GetSceneItemId", {
      sceneName: SCENE_NAME,
      sourceName: SOURCE_NAME
    });
  }

  // 3️⃣ Store sceneItemId
  if (msg.d?.requestType === "GetSceneItemId") {
    sceneItemId = msg.d.responseData.sceneItemId;
    console.log("Connected. SceneItemID:", sceneItemId);

    // Center anchor point
    request("SetSceneItemTransform", {
      sceneName: SCENE_NAME,
      sceneItemId,
      sceneItemTransform: {
        alignment: 5
      }
    });
  }
};

// ======================
// OBS REQUEST HELPER
// ======================
function request(type, data) {
  ws.send(JSON.stringify({
    op: 6,
    d: {
      requestType: type,
      requestId: crypto.randomUUID(),
      requestData: data
    }
  }));
}

// ======================
// CAMERA CONTROLS
// ======================
function zoom(factor) {
  scale *= factor;
  applyTransform();
}

function move(dx, dy) {
  posX += dx;
  posY += dy;
  applyTransform();
}

function resetView() {
  scale = 1.0;
  posX = 0;
  posY = 0;
  applyTransform();
}

function applyTransform() {
  if (sceneItemId === null) return;

  request("SetSceneItemTransform", {
    sceneName: SCENE_NAME,
    sceneItemId,
    sceneItemTransform: {
      scaleX: scale,
      scaleY: scale,
      positionX: posX,
      positionY: posY
    }
  });
}

// ======================
// SHA256 (required by OBS)
// ======================
async function sha256(text) {
  const data = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return btoa(String.fromCharCode(...new Uint8Array(hash)));
}
</script>

</body>
</html>
